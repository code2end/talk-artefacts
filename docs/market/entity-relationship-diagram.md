# Market Service Entity Relationship Diagram

```mermaid
classDiagram
    class ExchangeCoin {
        +String symbol
        +String coinSymbol
        +String baseSymbol
        +int enable
        +BigDecimal fee
        +int sort
        +int coinScale
        +int baseCoinScale
        +BigDecimal minSellPrice
        +BigDecimal maxBuyPrice
        +int visible
        +int exchangeable
        +int zone
        +ExchangeCoinPublishType publishType
        +String startTime
        +String endTime
        +BigDecimal publishPrice
        +BigDecimal publishAmount
    }

    class ExchangeTrade {
        +String symbol
        +BigDecimal price
        +BigDecimal amount
        +BigDecimal buyTurnover
        +BigDecimal sellTurnover
        +ExchangeOrderDirection direction
        +String buyOrderId
        +String sellOrderId
        +Long time
    }

    class KLine {
        +BigDecimal openPrice
        +BigDecimal highestPrice
        +BigDecimal lowestPrice
        +BigDecimal closePrice
        +long time
        +String period
        +int count
        +BigDecimal volume
        +BigDecimal turnover
    }

    class CoinThumb {
        +String symbol
        +BigDecimal open
        +BigDecimal high
        +BigDecimal low
        +BigDecimal close
        +BigDecimal chg
        +BigDecimal change
        +BigDecimal volume
        +BigDecimal turnover
        +BigDecimal lastDayClose
        +BigDecimal usdRate
        +BigDecimal baseUsdRate
        +int zone
    }

    class ExchangeOrder {
        +String orderId
        +Long memberId
        +ExchangeOrderType type
        +String symbol
        +ExchangeOrderDirection direction
        +BigDecimal price
        +BigDecimal amount
        +BigDecimal tradedAmount
        +BigDecimal turnover
        +ExchangeOrderStatus status
        +Long time
        +Long completedTime
        +Long canceledTime
    }

    class TradePlate {
        +String symbol
        +List~TradePlateItem~ items
        +ExchangeOrderDirection direction
        +BigDecimal maxAmount
        +BigDecimal minAmount
        +BigDecimal highestPrice
        +BigDecimal lowestPrice
    }

    class TradePlateItem {
        +BigDecimal price
        +BigDecimal amount
    }

    class ExchangeOrderDirection {
        <<enumeration>>
        BUY
        SELL
    }

    class ExchangeOrderStatus {
        <<enumeration>>
        TRADING
        COMPLETED
        CANCELED
        OVERTIMED
    }

    class ExchangeOrderType {
        <<enumeration>>
        MARKET_ORDER
        LIMIT_ORDER
    }

    class ExchangeCoinPublishType {
        <<enumeration>>
        NONE
        PURCHASE
        DISTRIBUTION
    }

    class BooleanEnum {
        <<enumeration>>
        IS_TRUE
        IS_FALSE
    }

    %% Primary relationships
    ExchangeCoin "1" ||--o{ "many" ExchangeTrade : contains
    ExchangeCoin "1" ||--|| "1" CoinThumb : has_current_data
    ExchangeCoin "1" ||--o{ "many" TradePlate : has_orderbook
    ExchangeCoin "1" ||--o{ "many" ExchangeOrder : accepts_orders

    %% Trade processing relationships  
    ExchangeTrade "many" }o--|| "1" ExchangeOrder : buy_order
    ExchangeTrade "many" }o--|| "1" ExchangeOrder : sell_order
    ExchangeTrade "many" }|--|| "1" KLine : aggregated_into

    %% Order book relationships
    TradePlate "1" ||--o{ "many" TradePlateItem : contains
    
    %% Enum relationships
    ExchangeTrade }o--|| ExchangeOrderDirection : has_direction
    ExchangeOrder }o--|| ExchangeOrderDirection : has_direction
    ExchangeOrder }o--|| ExchangeOrderStatus : has_status
    ExchangeOrder }o--|| ExchangeOrderType : has_type
    ExchangeCoin }o--|| ExchangeCoinPublishType : has_publish_type
    TradePlate }o--|| ExchangeOrderDirection : has_direction
```

## Entity Relationship Description

This class diagram illustrates the key entities in the Market Service and their relationships:

### 1. Core Entities

- **ExchangeCoin**: The central configuration entity that defines trading pairs and their rules. Every other entity relates back to a specific trading pair through the symbol field.

- **ExchangeTrade**: Represents individual trade executions. These are the atomic units of trading activity that drive all market data calculations.

- **KLine**: Time-series candlestick data generated by aggregating ExchangeTrade records over specific time periods (1min, 5min, 1hour, etc.).

- **CoinThumb**: Real-time market statistics calculated from recent ExchangeTrade activity. Each trading pair has one current CoinThumb record.

- **ExchangeOrder**: Individual buy/sell orders placed by users. Multiple trades can execute against a single order (partial fills).

- **TradePlate**: Order book depth data showing buy/sell pressure at different price levels.

### 2. Key Relationships

- **ExchangeCoin ↔ ExchangeTrade**: One-to-many relationship where all trades belong to a specific trading pair. The trading pair configuration controls trade validation and processing rules.

- **ExchangeTrade ↔ ExchangeOrder**: Many-to-many relationship through buy/sell order references. Each trade involves exactly one buy order and one sell order, but orders can participate in multiple trades.

- **ExchangeTrade ↔ KLine**: Many-to-one aggregation relationship where multiple trades within a time period contribute to a single K-line record. This aggregation happens through scheduled jobs.

- **ExchangeCoin ↔ CoinThumb**: One-to-one relationship where each trading pair maintains one current market data summary that gets updated as trades occur.

- **TradePlate ↔ TradePlateItem**: One-to-many composition where each order book contains multiple price level entries.

### 3. Embedded Objects

- **TradePlateItem**: Simple value objects embedded within TradePlate entities to represent individual price/amount pairs in the order book.

### 4. Status Enumerations

- **ExchangeOrderDirection**: Defines trade/order direction (BUY/SELL) used across multiple entities

- **ExchangeOrderStatus**: Tracks order lifecycle states (TRADING, COMPLETED, CANCELED, OVERTIMED)

- **ExchangeOrderType**: Distinguishes between market and limit orders (MARKET_ORDER, LIMIT_ORDER)

- **ExchangeCoinPublishType**: Defines special issuance activities for new coin launches (NONE, PURCHASE, DISTRIBUTION)

- **BooleanEnum**: Custom boolean enumeration used throughout the system (IS_TRUE, IS_FALSE)

### 5. Data Flow Relationships

The diagram shows both structural relationships and data flow patterns:

1. **Trade Execution Flow**: ExchangeOrder → ExchangeTrade → CoinThumb/KLine updates
2. **Market Data Generation**: ExchangeTrade aggregation → KLine creation for different periods  
3. **Real-time Updates**: ExchangeTrade → CoinThumb statistics → WebSocket broadcast
4. **Order Book Management**: ExchangeOrder changes → TradePlate updates → Client distribution

### 6. MongoDB Collection Mapping

The entities map to MongoDB collections as follows:

- **KLine**: `exchange_kline_{symbol}_{period}` collections (time-series data)
- **ExchangeTrade**: `exchange_trade_{symbol}` collections (trade history)
- **TradePlate**: Cached in Redis and distributed via messaging (not persisted)
- **CoinThumb**: Calculated in memory and cached in Redis (not persisted)

This diagram provides a visual representation of the actual data model relationships in the Market Service codebase, showing how trading activity flows through the system to generate market data, charts, and real-time updates for clients.
